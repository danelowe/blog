<!DOCTYPE html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http_equiv='X-UA-Compatible'>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<link href='https://fonts.googleapis.com/css?family=Oxygen:300,400,700' rel='stylesheet' type='text/css'>
<link href='apple-touch-icon-152x152-precomposed.png' rel='apple-touch-icon' sizes='152x152'>
<link href='apple-touch-icon-144x144-precomposed.png' rel='apple-touch-icon' sizes='144x144'>
<link href='apple-touch-icon-114x114-precomposed.png' rel='apple-touch-icon' sizes='114x114'>
<link href='apple-touch-icon-72x72-precomposed.png' rel='apple-touch-icon' sizes='72x72'>
<link href='apple-touch-icon-precomposed.png' rel='apple-touch-icon'>
<link href='favicon.png' rel='shortcut icon'>
<link href='favicon.ico' rel='icon' type='image/ico'>
<title>Dane Lowe - A blog about Ruby, Rails and Magento</title>
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
<link href="/stylesheets/all-5c3f3084.css" rel="stylesheet" type="text/css" />
<script src="/javascripts/all-b51db3d4.js" type="text/javascript"></script>
</head>
<body class='x2015 x2015_11 x2015_11_14'>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-24341865-3', 'danelowe.name');
  ga('send', 'pageview');
</script>

<header>
<section class='container'>
<strong><a href="/">Dane Lowe</a></strong>
<div class='tags_list'>
<a href="/tags/magento.html">Magento</a>
<a href="/tags/ruby.html">Ruby</a>
<a href="/tags/patterns.html">Patterns</a>
<a href="/tags/sysadmin.html">Sysadmin</a>
</div>
</section>
</header>
<section class='container' id='content'><h1>
Archive for
Nov 14 2015
</h1>
<div class='post_list'>
<div class='post' data-href='/magento-flat-catalog-remembers-store-id.html'>
<div class='data'>
<span class='date'>14 November 2015</span>
<div class='tags_list'>
<a href="/tags/magento.html">Magento</a>
</div>
</div>
<div class='intro'>
<h2><a href="/magento-flat-catalog-remembers-store-id.html">Magento's Flat Catalog Remembers Store ID</a></h2>
<p>If you're using store emulation, and loading product collections while emulating a store,
you need to be aware of one massive gotcha.</p>

<p><strong>Magento keeps the store id for a flat collection in a <em>singleton</em></strong></p>

<p>Consider the following code: </p>

<pre class="highlight php"><code><span class="cp">&lt;?php</span> 
<span class="k">public</span> <span class="k">function</span> <span class="nf">reindexAll</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nx">Mage</span><span class="o">::</span><span class="na">app</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getStores</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$_store</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_reindex</span><span class="p">(</span><span class="nv">$_store</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">_reindex</span><span class="p">(</span><span class="nv">$storeId</span><span class="p">,</span> <span class="nv">$products</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$initialEnvironment</span> <span class="o">=</span> <span class="nx">Mage</span><span class="o">::</span><span class="na">getSingleton</span><span class="p">(</span><span class="s1">'core/app_emulation'</span><span class="p">)</span></code></pre>
</div>
</div>
</div>


</section>
<footer>
<section class='container'>
<div class='column'>
<h2>Recent Articles</h2>
<ol>
<li><a href="/magento-flat-catalog-remembers-store-id.html">Magento's Flat Catalog Remembers Store ID</a></li>
<li><a href="/how-time-fields-work-in-magento.html">How Time Fields work in Magento</a></li>
<li><a href="/simple-and-robust-nginx-config-for-magento.html">Simple and Robust Nginx config for Magento</a></li>
<li><a href="/if-business-logic-worked-like-a-business.html">If Business Logic worked like a business</a></li>
<li><a href="/bulk-updating-eav-attributes-in-magento.html">Bulk updating EAV attributes in Magento</a></li>
<li><a href="/how-to-get-an-eav-product-collection-when-flat-catalog-is-enabled.html">How to get an EAV product collection when Flat Catalog is Enabled</a></li>
</ol>
</div>
<div class='column'>
<h2>Tags</h2>
<ol>
<li><a href="/tags/magento.html">Magento (5)</a></li>
<li><a href="/tags/ruby.html">Ruby (1)</a></li>
<li><a href="/tags/patterns.html">Patterns (1)</a></li>
<li><a href="/tags/sysadmin.html">Sysadmin (1)</a></li>
</ol>
</div>
<div class='column'>
<h2>About</h2>
<p>Hi. I'm Dane, a web developer that works with Magento, Ruby and HTML/CSS/JS</p>
<p>
<span class='e'>dane</span>
</p>
</div>
</section>
</footer>
</body>
