<!DOCTYPE html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http_equiv='X-UA-Compatible'>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<link href='https://fonts.googleapis.com/css?family=Oxygen:300,400,700' rel='stylesheet' type='text/css'>
<link href='apple-touch-icon-152x152-precomposed.png' rel='apple-touch-icon' sizes='152x152'>
<link href='apple-touch-icon-144x144-precomposed.png' rel='apple-touch-icon' sizes='144x144'>
<link href='apple-touch-icon-114x114-precomposed.png' rel='apple-touch-icon' sizes='114x114'>
<link href='apple-touch-icon-72x72-precomposed.png' rel='apple-touch-icon' sizes='72x72'>
<link href='apple-touch-icon-precomposed.png' rel='apple-touch-icon'>
<link href='favicon.png' rel='shortcut icon'>
<link href='favicon.ico' rel='icon' type='image/ico'>
<title>How Time Fields work in Magento</title>
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
<link href="/stylesheets/all-5c3f3084.css" rel="stylesheet" type="text/css" />
<script src="/javascripts/all-b51db3d4.js" type="text/javascript"></script>
</head>
<body class='how-time-fields-work-in-magento'>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-24341865-3', 'danelowe.name');
  ga('send', 'pageview');
</script>

<header>
<section class='container'>
<strong><a href="/">Dane Lowe</a></strong>
<div class='tags_list'>
<a href="/tags/magento.html">Magento</a>
<a href="/tags/ruby.html">Ruby</a>
<a href="/tags/patterns.html">Patterns</a>
<a href="/tags/sysadmin.html">Sysadmin</a>
</div>
</section>
</header>
<section class='container' id='content'><div class='post'>
<div class='data'>
<span class='date'>23 September 2015</span>
<div class='tags_list'>
<a href="/tags/magento.html">Magento</a>
</div>
</div>
<div class='content'>
<h1>How Time Fields work in Magento</h1>
<p>Magento stores time values in the system config database table as 
comma-separated values for hours, minutes, and seconds, 
but it displays the configuration options as three dropdown boxes.</p>

<p>I've often wondered what class controlled this behaviour, 
thinking there would be some canonical way of creating config values composed of multiple HTMl fields.</p>

<p>As it turns out, this behaviour is not specific to time fields. 
<code>core/config_data</code> models just naively serialize arrays to comma-separated values before saving.</p>

<pre class="highlight php"><code><span class="cp">&lt;?php</span>
<span class="c1"># Mage_Core_Model_Resource_Config_Data
</span><span class="sd">/**
 * Convert array to comma separated value
 *
 * @param Mage_Core_Model_Abstract $object
 * @return Mage_Core_Model_Resource_Config_Data
 */</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">_beforeSave</span><span class="p">(</span><span class="nx">Mage_Core_Model_Abstract</span> <span class="nv">$object</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$object</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_checkUnique</span><span class="p">(</span><span class="nv">$object</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$object</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">()))</span> <span class="p">{</span>
        <span class="nv">$object</span><span class="o">-&gt;</span><span class="na">setValue</span><span class="p">(</span><span class="nb">join</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span> <span class="nv">$object</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">()));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">_beforeSave</span><span class="p">(</span><span class="nv">$object</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<p>And the form field class just deserializes it.</p>

<pre class="highlight php"><code><span class="cp">&lt;?php</span>
<span class="c1"># Varien_Data_Form_Element_Time#getElementHtml()
</span><span class="k">if</span><span class="p">(</span> <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nv">$values</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$values</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$value_hrs</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nv">$value_min</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="nv">$value_sec</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Not the greatest implementation, and certainly no silver bullet for creating composed config fields 
that know how to serialize/deserialize the data.
It's probably best to just create a backend model for these complex fields.</p>

<p>When saving config data in the admin:</p>

<ul>
  <li>The controller grabs a singleton of <code>adminhtml/config_data</code></li>
  <li>That singleton then creates a <code>$saveTransaction</code> and <code>$deleteTransaction</code>, 
loops through the data and populates each with an array of baackend models for each field.</li>
  <li>When the transactions are committed, they just call save on each backend model in turn.</li>
</ul>


<div id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
                  var disqus_shortname = 'danelowe';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
//<![CDATA[
    var disqus_shortname = 'danelowe';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script>

</div>
</div>
</section>
<footer>
<section class='container'>
<div class='column'>
<h2>Recent Articles</h2>
<ol>
<li><a href="/how-time-fields-work-in-magento.html">How Time Fields work in Magento</a></li>
<li><a href="/simple-and-robust-nginx-config-for-magento.html">Simple and Robust Nginx config for Magento</a></li>
<li><a href="/if-business-logic-worked-like-a-business.html">If Business Logic worked like a business</a></li>
<li><a href="/bulk-updating-eav-attributes-in-magento.html">Bulk updating EAV attributes in Magento</a></li>
<li><a href="/how-to-get-an-eav-product-collection-when-flat-catalog-is-enabled.html">How to get an EAV product collection when Flat Catalog is Enabled</a></li>
</ol>
</div>
<div class='column'>
<h2>Tags</h2>
<ol>
<li><a href="/tags/magento.html">Magento (4)</a></li>
<li><a href="/tags/ruby.html">Ruby (1)</a></li>
<li><a href="/tags/patterns.html">Patterns (1)</a></li>
<li><a href="/tags/sysadmin.html">Sysadmin (1)</a></li>
</ol>
</div>
<div class='column'>
<h2>About</h2>
<p>Hi. I'm Dane, a web developer that works with Magento, Ruby and HTML/CSS/JS</p>
<p>
<span class='e'>dane</span>
</p>
</div>
</section>
</footer>
</body>
