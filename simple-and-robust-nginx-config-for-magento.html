<!DOCTYPE html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http_equiv='X-UA-Compatible'>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<link href='https://fonts.googleapis.com/css?family=Oxygen:300,400,700' rel='stylesheet' type='text/css'>
<link href='apple-touch-icon-152x152-precomposed.png' rel='apple-touch-icon' sizes='152x152'>
<link href='apple-touch-icon-144x144-precomposed.png' rel='apple-touch-icon' sizes='144x144'>
<link href='apple-touch-icon-114x114-precomposed.png' rel='apple-touch-icon' sizes='114x114'>
<link href='apple-touch-icon-72x72-precomposed.png' rel='apple-touch-icon' sizes='72x72'>
<link href='apple-touch-icon-precomposed.png' rel='apple-touch-icon'>
<link href='favicon.png' rel='shortcut icon'>
<link href='favicon.ico' rel='icon' type='image/ico'>
<title>Simple and Robust Nginx config for Magento</title>
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
<link href="/stylesheets/all-5c3f3084.css" rel="stylesheet" type="text/css" />
<script src="/javascripts/all-b51db3d4.js" type="text/javascript"></script>
</head>
<body class='simple-and-robust-nginx-config-for-magento'>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-24341865-3', 'danelowe.name');
  ga('send', 'pageview');
</script>

<header>
<section class='container'>
<strong><a href="/">Dane Lowe</a></strong>
<div class='tags_list'>
<a href="/tags/magento.html">Magento</a>
<a href="/tags/ruby.html">Ruby</a>
<a href="/tags/patterns.html">Patterns</a>
<a href="/tags/sysadmin.html">Sysadmin</a>
</div>
</section>
</header>
<section class='container' id='content'><div class='post'>
<div class='data'>
<span class='date'> 5 February 2015</span>
<div class='tags_list'>
<a href="/tags/magento.html">Magento</a>
<a href="/tags/sysadmin.html">Sysadmin</a>
</div>
</div>
<div class='content'>
<h1>Simple and Robust Nginx config for Magento</h1>
<p>I have a few requirements for my Magento Nginx configuration</p>

<ol>
  <li>I need to understand what it is doing, at first glance.</li>
  <li>I need to be able to create subdomains in a DRY fashion.</li>
  <li>It needs to be secure.</li>
  <li>It needs to work, and be performant.</li>
</ol>

<p>This is not using any load-balancer. It is a single server fronted by Nginx.</p>

<p>This isn't too much to ask, but the idiomatic Nginx config for Magento just wasn't cutting it for me. </p>

<p>I've always been bugged by the fact that Magento dumps application code, shell scripts and configuration files
directly in the public directory.
If one bit of config is missed, or a compromising file is added or renamed without updating the nginx config, 
that becomes one opportunity for the wrong file to be accessed in the wrong way via the web server. </p>

<p>So, what can we do? We can revisit the way Magento is served:</p>

<ul>
  <li>We define an 'App Server' that only serves the Magento App, and nothing else.</li>
  <li>We define one or more 'Asset Servers' that only serve static assets.</li>
  <li>On the App server, we route every single request through one of the few whitelisted entry points for Magento.</li>
  <li>On the Asset Servers, we only serve files from whitelisted directories. </li>
  <li>We optimise the configuration of each server separately. </li>
  <li>We make use of generic includes to make our intentions clearer, and make it easier to add new server configs.</li>
</ul>

<p>Not only is this approach a little more secure, it makes things a lot easier to reason and maintain. 
Have a look through the configuration below and see if you would agree. </p>

<h2 id="the-app-server">The App Server</h2>

<pre class="highlight nginx"><code><span class="c1"># sites-available/mydomain
</span><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>         <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span>    <span class="s">mydomain.com</span> <span class="s">www.mydomain.com</span><span class="p">;</span>
    <span class="kn">rewrite</span>        <span class="s">^</span> <span class="s">https://www.mydomain.com</span><span class="nv">$request_uri</span><span class="s">?</span> <span class="s">permanent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">443</span> <span class="s">default</span> <span class="s">ssl</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">mydomain.com</span> <span class="s">www.mydomain.com</span><span class="p">;</span>
    <span class="kn">root</span> <span class="n">/var/www/magento/current/public</span><span class="p">;</span>

    <span class="kn">include</span> <span class="nc">includes/ssl</span><span class="p">;</span>
    <span class="kn">include</span> <span class="nc">includes/mage</span><span class="p">;</span>

    <span class="kn">fastcgi_param</span>  <span class="s">MAGE_RUN_CODE</span> <span class="s">default</span><span class="p">;</span>

    <span class="kn">location</span> <span class="n">/admin</span>               <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The first server block simply redirects any HTTP request to HTTPS.</p>

<p>I don't think there is any reason not to do this, and plenty of reasons to always do it. 
The overheads are probably negligible when you've already got Magento as an overhead. 
Any cookie that is sent over HTTP has the potential to be intercepted. 
Remember, Magento uses a persistent session ID stored in a cookie.</p>

<p>Note the use of the includes. 
This is simply including boilerplate config that will be shared among all of the 'app servers'.
I will show you this boilerplate config in a tick. </p>

<p>In this case, each app server represents a new store view with a specified domain.
For this reason, the MAGE_RUN_CODE is specified in this server block. 
There probably is a way of conditionally defining the MAGE_RUN_CODE within the same server block,
but it feels much cleaner to me to define each domain in it's own server block.</p>

<p>This particular app server does not allow access to the admin interface. It will always return a 404 here. </p>

<h3 id="the-magento-boilerplate">The Magento Boilerplate</h3>

<pre class="highlight nginx"><code><span class="c1"># includes/mage
</span><span class="k">gzip</span>             <span class="no">on</span><span class="p">;</span>
<span class="k">gzip_min_length</span>  <span class="mi">1000</span><span class="p">;</span>
<span class="k">gzip_proxied</span>     <span class="s">expired</span> <span class="s">no-cache</span> <span class="s">no-store</span> <span class="s">private</span> <span class="s">auth</span><span class="p">;</span>
<span class="k">gzip_types</span>       <span class="nc">text/plain</span> <span class="nc">application/xml</span> <span class="nc">application/x-javascript</span> <span class="nc">text/css</span><span class="p">;</span>
<span class="k">gzip_disable</span>     <span class="s">"MSIE</span> <span class="s">[1-6]</span><span class="err">\</span><span class="s">."</span><span class="p">;</span>

<span class="k">expires</span>        <span class="no">off</span><span class="p">;</span>
<span class="k">include</span>        <span class="n">fastcgi_params</span>;
<span class="k">fastcgi_param</span>  <span class="s">HTTPS</span> <span class="nv">$fastcgi_https</span><span class="p">;</span>
<span class="k">fastcgi_param</span>  <span class="s">SCRIPT_FILENAME</span>  <span class="nv">$document_root</span><span class="n">/index.php</span><span class="p">;</span>
<span class="k">fastcgi_param</span>  <span class="s">MAGE_RUN_TYPE</span> <span class="s">store</span><span class="p">;</span>


<span class="k">location</span> <span class="n">/api</span> <span class="p">{</span>
    <span class="kn">rewrite</span> <span class="s">^/api/rest</span> <span class="n">/api?type=rest</span> <span class="s">last</span><span class="p">;</span>
    <span class="kn">include</span>        <span class="s">fastcgi_params</span><span class="p">;</span> 
    <span class="kn">fastcgi_pass</span> <span class="s">unix:/dev/shm/php-fastcgi.socket</span><span class="p">;</span>
    <span class="kn">fastcgi_param</span>  <span class="s">SCRIPT_FILENAME</span>  <span class="nv">$document_root</span><span class="n">/api.php</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">location</span> <span class="p">=</span> <span class="n">/ajax</span> <span class="p">{</span>
    <span class="kn">include</span>        <span class="s">fastcgi_params</span><span class="p">;</span> 
    <span class="kn">fastcgi_pass</span> <span class="s">unix:/dev/shm/php-fastcgi.socket</span><span class="p">;</span>
    <span class="kn">fastcgi_param</span>  <span class="s">SCRIPT_FILENAME</span>  <span class="nv">$document_root</span><span class="n">/ajax.php</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">location</span> <span class="n">/</span> <span class="p">{</span>
    <span class="kn">fastcgi_pass</span> <span class="s">unix:/dev/shm/php-fastcgi.socket</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">location</span> <span class="p">~</span> <span class="sr">.php$</span>              <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/app/</span>                <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/downloader/</span>         <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/errors/</span>             <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/media/</span>              <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/assets/</span>             <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/images/</span>             <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/skin/</span>               <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/includes/</span>           <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/lib/</span>                <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/media/downloadable/</span> <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/pkginfo/</span>            <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/report/config.xml</span>   <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/shell/</span>              <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/var/</span>                <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
<span class="k">location</span> <span class="n">/.</span>                   <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>

<span class="k">if</span> <span class="s">(-f</span> <span class="nv">$document_root</span><span class="n">/maintenance.html</span><span class="s">)</span> <span class="p">{</span>
    <span class="kn">return</span> <span class="mi">503</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">error_page</span> <span class="mi">503</span> <span class="s">@maintenance</span><span class="p">;</span>
<span class="k">location</span> <span class="s">@maintenance</span> <span class="p">{</span>
    <span class="kn">try_files</span> <span class="n">/maintenance.html</span> <span class="p">=</span><span class="mi">404</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">error_page</span> <span class="mi">404</span> <span class="n">/404</span><span class="p">;</span>
</code></pre>

<p>Again, this configuration all seems quite simple and easy to understand. 
No complex rewrite rules or confusion over which location is matched.</p>

<p>Every single request to an 'App Server' is routed to PHP-FPM. 
No static assets or non-PHP files are served.</p>

<p>In addition, every single request is routed through one of three whitelisted entry points; 
index.php, api.php or ajax.php.
ajax.php is a custom entry point that I use for ajax requests that do not load the entire Magento environment.
Simply remove the location block to revoke access to that entry point. I love the simplicity. </p>

<p>Note all the locations that return 404. 
I think it is important to point out that this is not particularly required 
to prevent access to these files and directories. 
Remember any location that is not explicitly defined will be served via PHP-FPM using index.php as the entry point, 
and so will return a Magento 404. 
The point in these 404 locations is simply to increase performance in the case that any request is made 
to these locations, by circumventing PHP.</p>

<p>However, to contradict that, there is some config just below that uses the /404 location to serve any 404.
This will be routed through php as well to serve the Magento 404 page.
At the moment I'm considering whether to generate a static 404 page during the build process, 
or create another entry point that doesn't load the entire Magento environment.
You may want to consider changing this 404 config or removing the 404 locations.</p>

<h2 id="the-admin-server">The Admin server</h2>

<p>Remember we blocked access to the Magento admin at the web server level on the first 'App Server'. 
We need to define a new server block for our admin server. 
Note how little new config is needed.</p>

<pre class="highlight nginx"><code><span class="c1"># sites-available/admin
</span><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>         <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span>    <span class="s">magentoadmin.mydomain.com</span><span class="p">;</span>
    <span class="kn">rewrite</span>        <span class="s">^</span> <span class="s">https://magentoadmin.mydomain.com</span><span class="nv">$request_uri</span><span class="s">?</span> <span class="s">permanent</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="nf">123.123.123.123</span><span class="p">:</span><span class="mi">443</span> <span class="s">ssl</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">magentoadmin.mydomain.com</span><span class="p">;</span>
    <span class="kn">root</span> <span class="n">/var/www/magento/current/public</span><span class="p">;</span>

    <span class="kn">include</span> <span class="nc">includes/ssl</span><span class="p">;</span>
    <span class="kn">include</span> <span class="nc">includes/mage</span><span class="p">;</span>

    <span class="kn">auth_basic</span>            <span class="s">"mage"</span><span class="p">;</span>
    <span class="kn">auth_basic_user_file</span>  <span class="s">htpasswd</span><span class="p">;</span>
    <span class="kn">fastcgi_param</span>  <span class="s">MAGE_RUN_CODE</span> <span class="s">default</span><span class="p">;</span>
    <span class="kn">location</span> <span class="p">=</span> <span class="n">/</span> <span class="p">{</span>
        <span class="kn">return</span> <span class="mi">301</span> <span class="s">https://magentoadmin.mydomain.com/index.php/admin</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>It is immediately clear what the differences are. 
We redirect to the admin path for convenience, and require a HTTP Basic Auth password.</p>

<p>The password is a quick and convenient way to add a bit of extra security because:</p>

<ul>
  <li>It means you're not 100% reliant on Magento/PHP to provide security. 
A lot of attack vectors could be removed if one is refused by the web server. </li>
  <li>It can mask the fact that you're even using Magento. </li>
  <li>It makes it easy to use tools like Fail2Ban to lock out a brute force attack.</li>
  <li>It means that a brute-force won't be using up the server's resources as much as it otherwise would.</li>
</ul>

<h2 id="asset-servers">Asset Servers</h2>

<pre class="highlight nginx"><code><span class="c1"># sites-available/assets
</span><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span>  <span class="s">assets.mydomain.com</span><span class="p">;</span>
    <span class="kn">root</span>  <span class="n">/var/www/magento/current/public/assets</span><span class="p">;</span>
    <span class="kn">include</span> <span class="nc">includes/assets</span><span class="p">;</span>
    <span class="kn">location</span> <span class="n">/assets/</span> <span class="p">{</span>
        <span class="kn">alias</span> <span class="n">/var/www/magento/current/public/assets/</span><span class="p">;</span>
        <span class="kn">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="n">/media/</span> <span class="p">{</span>
        <span class="kn">alias</span> <span class="n">/var/www/magento/current/public/media/</span><span class="p">;</span>
        <span class="kn">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="n">/images/</span> <span class="p">{</span>
        <span class="kn">alias</span> <span class="n">/var/www/magento/current/public/images/</span><span class="p">;</span>
        <span class="kn">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="n">/skin/</span> <span class="p">{</span>
        <span class="kn">alias</span> <span class="n">/var/www/magento/current/public/skin/</span><span class="p">;</span>
        <span class="kn">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Again it is immediately clear what we are doing.
We are 'whitelisting' some directories to serve static assets from on assets.mydomain.com. </p>

<p><strong>Note:</strong> You'll want to make sure your assets are served via HTTPS as well. 
This server is not set up for HTTPS, 
but would do as a backend for a CDN like CloudFront that will have its own SSL certificate.</p>

<h3 id="the-asset-boilerplate">The Asset Boilerplate</h3>

<p>Add any config you want here to apply to all static assets, 
e.g. set their expires headers, static GZip, and hotlink protection. 
You could also explicitly whitelist the file types here too. Or set some CORS headers.  </p>

<pre class="highlight nginx"><code><span class="c1"># includes/assets
</span><span class="k">add_header</span> <span class="s">"Access-Control-Allow-Origin"</span> <span class="s">"*"</span><span class="p">;</span>
<span class="k">gzip_static</span> <span class="no">on</span><span class="p">;</span>
<span class="k">expires</span> <span class="s">max</span><span class="p">;</span>
<span class="k">add_header</span> <span class="s">Cache-Control</span> <span class="s">public</span><span class="p">;</span>
<span class="k">valid_referers</span> <span class="s">none</span> <span class="s">blocked</span> <span class="s">mydomain.com</span> <span class="s">*.mydomain.com</span><span class="p">;</span>
<span class="k">if</span> <span class="s">(</span><span class="nv">$invalid_referer</span><span class="s">)</span> <span class="p">{</span>
    <span class="kn">return</span>   <span class="mi">403</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<h2 id="the-complete-setup">The complete setup.</h2>

<p>Put all these files together, and you'll have what 
I consider to be quite a simple and reasonable Nginx configuration to serve a Magento site from a single box. </p>

<p>Is there anything that you would add or change? </p>

<p>P.S. I actually have these files as part of my repository, and change nginx.conf to include them</p>

<p>P.P.S <strong>Don't forget to setup Magento to use the static asset servers, 
and make sure to whitelist your sitemaps and any product feeds you may have</strong>  </p>

<div id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
                  var disqus_shortname = 'danelowe';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
//<![CDATA[
    var disqus_shortname = 'danelowe';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script>

</div>
</div>
</section>
<footer>
<section class='container'>
<div class='column'>
<h2>Recent Articles</h2>
<ol>
<li><a href="/simple-and-robust-nginx-config-for-magento.html">Simple and Robust Nginx config for Magento</a></li>
<li><a href="/if-business-logic-worked-like-a-business.html">If Business Logic worked like a business</a></li>
<li><a href="/bulk-updating-eav-attributes-in-magento.html">Bulk updating EAV attributes in Magento</a></li>
<li><a href="/how-to-get-an-eav-product-collection-when-flat-catalog-is-enabled.html">How to get an EAV product collection when Flat Catalog is Enabled</a></li>
</ol>
</div>
<div class='column'>
<h2>Tags</h2>
<ol>
<li><a href="/tags/magento.html">Magento (3)</a></li>
<li><a href="/tags/ruby.html">Ruby (1)</a></li>
<li><a href="/tags/patterns.html">Patterns (1)</a></li>
<li><a href="/tags/sysadmin.html">Sysadmin (1)</a></li>
</ol>
</div>
<div class='column'>
<h2>About</h2>
<p>Hi. I'm Dane, a web developer that works with Magento, Ruby and HTML/CSS/JS</p>
<p>
<span class='e'>dane</span>
</p>
</div>
</section>
</footer>
</body>
